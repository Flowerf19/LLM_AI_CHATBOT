# Migration Guide: V2.0 â†’ V2.1

HÆ°á»›ng dáº«n nÃ¢ng cáº¥p tá»« V2.0 lÃªn V2.1 vá»›i cÃ¡c tÃ­nh nÄƒng má»›i.

---

## ğŸ“Š Nhá»¯ng thay Ä‘á»•i chÃ­nh

### 1. **Lazy Sync Queue** (New)
- File má»›i: `data/system/pending_updates.json`
- Service má»›i: `PendingUpdateService`

### 2. **Context Overlap** (Enhanced)
- `BatchProcessor` giá» gá»­i context messages cho AI
- Prompt format má»›i vá»›i pháº§n Context (read-only)

### 3. **Hybrid Trigger** (Enhanced)
- Time Flush: Tá»± Ä‘á»™ng trigger sau 30 phÃºt
- Batch Full: Trigger khi Ä‘á»§ 10 tin (khÃ´ng Ä‘á»•i)

### 4. **Data Safety** (Enhanced)
- AsyncIO Lock Ä‘Ã£ Ä‘Æ°á»£c tÃ­ch há»£p sáºµn trong `data_manager`

---

## ğŸ”„ Migration Steps

### Step 1: Create system directory
```bash
mkdir -p data/system
```

### Step 2: Initialize pending_updates.json
```bash
echo '{"server_id": "default", "queue": {}, "last_processed": "'$(date -u +"%Y-%m-%dT%H:%M:%S")'"}' > data/system/pending_updates.json
```

### Step 3: Update bot.py imports
```python
# Old V2.0
from src.services.conversation.batch_processor import batch_processor

# New V2.1 (add these)
from src.services.conversation.pending_update_service import pending_update_service
```

### Step 4: Update on_message handler

**Before (V2.0):**
```python
@bot.event
async def on_message(message):
    if message.author.bot:
        return
    
    # Add to log
    should_trigger = await recent_log_service.add_activity(...)
    
    # Process if triggered
    if should_trigger:
        await batch_processor.process_batch()
```

**After (V2.1):**
```python
@bot.event
async def on_message(message):
    if message.author.bot:
        return
    
    user_id = str(message.author.id)
    server_id = str(message.guild.id)
    
    # NEW: Check pending updates (Lazy Sync)
    if await pending_update_service.has_pending_updates(user_id, server_id):
        updates = await pending_update_service.get_pending_updates(user_id, server_id)
        # TODO: Apply updates to user profile
        await pending_update_service.clear_pending_updates(user_id, server_id)
    
    # Add to log
    should_trigger = await recent_log_service.add_activity(
        user_id=user_id,
        username=message.author.name,
        content=message.content,
        channel_id=str(message.channel.id),
        server_id=server_id
    )
    
    # Process if triggered
    if should_trigger:
        await batch_processor.process_batch(server_id)  # NEW: Pass server_id
```

---

## ğŸ§ª Testing Migration

### Test 1: Time Flush
```python
# Gá»­i 1 tin nháº¯n
# Äá»£i 31 phÃºt
# Gá»­i 1 tin nháº¯n ná»¯a
# â†’ Batch sáº½ Ä‘Æ°á»£c trigger (chá»‰ 2 tin nháº¯n)
```

### Test 2: Lazy Sync
```python
# User A chat vá»›i User B
# AI phÃ¡t hiá»‡n relationship event
# â†’ Pending update Ä‘Æ°á»£c táº¡o cho User B
# User B chat láº¡i
# â†’ Pending update Ä‘Æ°á»£c apply
```

### Test 3: Context Overlap
```python
# Gá»­i 10 tin nháº¯n (batch 1)
# Gá»­i 10 tin nháº¯n ná»¯a (batch 2)
# â†’ Batch 2 sáº½ cÃ³ 5 tin tá»« batch 1 lÃ m context
```

---

## âš ï¸ Breaking Changes

### None!
V2.1 backward compatible vá»›i V2.0. Code cÅ© váº«n cháº¡y Ä‘Æ°á»£c, chá»‰ khÃ´ng cÃ³ features má»›i.

---

## ğŸ› Troubleshooting

### Issue: "Import could not be resolved"
**Solution:** 
```bash
# Check PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:/path/to/discord-bot-gemini"
```

### Issue: "File not found: pending_updates.json"
**Solution:**
```bash
mkdir -p data/system
# File sáº½ tá»± Ä‘á»™ng Ä‘Æ°á»£c táº¡o láº§n Ä‘áº§u sá»­ dá»¥ng service
```

### Issue: "Time Flush khÃ´ng trigger"
**Solution:**
Check `first_msg_in_batch_at` trong `recent_log.json`:
```bash
cat data/recent_log.json | grep first_msg_in_batch_at
```

---

## ğŸ“š Reference

- [V2.1 Design Doc](./V2_DESIGN.md)
- [Implementation Summary](./V2.1_IMPLEMENTATION.md)
- [Integration Example](../src/services/conversation/integration_example.py)
